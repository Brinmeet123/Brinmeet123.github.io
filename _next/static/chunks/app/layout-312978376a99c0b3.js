(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[185],{450:function(e,t,n){Promise.resolve().then(n.t.bind(n,3254,23)),Promise.resolve().then(n.bind(n,1609)),Promise.resolve().then(n.t.bind(n,2972,23))},1609:function(e,t,n){"use strict";n.d(t,{default:function(){return u}});var r=n(7437),l=n(2265),i=n(8523);function a(e){return e.trim().toLowerCase().replace(/\s+/g," ").replace(/[.,;:!?]/g,"")}async function s(e,t,n){let r=e.trim();a(r);let l=function(e){let t=a(e),n=(0,i.lq)(t);return n||(n=(0,i.lq)(e.trim().toLowerCase()))?n:null}(r);if(l)return{term:l.term,definitionSimple:l.definitionSimple,definitionClinical:l.definitionClinical,whyItMatters:l.whyItMatters,example:l.exampleSimple,source:"local"};try{let e=await fetch("/api/explain-term",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({selectedText:r,contextText:(null==n?void 0:n.contextText)||"",sourceType:(null==n?void 0:n.sourceType)||"chat",scenarioMeta:null==n?void 0:n.scenarioMeta,viewMode:t})});if(!e.ok)return console.error("Failed to get AI explanation:",e.statusText),null;let l=await e.json();return{term:l.term||r,definitionSimple:l.definitionSimple||"",definitionClinical:l.definitionClinical||"",whyItMatters:l.whyItMatters||"",whyItMattersHere:l.whyItMattersHere,example:l.example||"",exampleFromContext:l.exampleFromContext,synonymsOrRelated:l.synonymsOrRelated,source:"ai"}}catch(e){return console.error("Error fetching AI explanation:",e),null}}var o=n(630);function c(e){let t,n,{explanation:i,position:a,onClose:s,onSave:c,viewMode:u="simple"}=e,d=(0,l.useRef)(null),{save:m,has:x}=(0,o.w)(),[g,h]=(0,l.useState)(!1),[f,p]=(0,l.useState)(!1);if((0,l.useEffect)(()=>{let e=e=>{"Escape"===e.key&&s()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[s]),(0,l.useEffect)(()=>{let e=e=>{d.current&&!d.current.contains(e.target)&&s()};if(i)return setTimeout(()=>{document.addEventListener("mousedown",e)},100),()=>document.removeEventListener("mousedown",e)},[i,s]),(0,l.useEffect)(()=>{i&&h(x(i.term))},[i,x]),!i||!a)return null;let y=i.term&&(i.definitionSimple||i.definitionClinical),v=!y||f||g,b=(t=a.x,n=a.y-10,t+320>window.innerWidth-10&&(t=window.innerWidth-320-10),t<10&&(t=10),n-400<10&&(n=a.y+30),{x:t,y:n});return(0,r.jsxs)("div",{ref:d,className:"fixed z-50 bg-white rounded-lg shadow-xl border-2 border-primary-200 p-4 max-w-xs",style:{left:"".concat(b.x,"px"),top:"".concat(b.y,"px"),transform:"translate(-50%, -100%)",maxWidth:"320px"},onClick:e=>e.stopPropagation(),children:[(0,r.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,r.jsx)("h4",{className:"font-bold text-lg text-primary-900",children:i.term}),(0,r.jsx)("button",{onClick:s,className:"text-gray-400 hover:text-gray-600 ml-2 text-xl leading-none","aria-label":"Close",children:"\xd7"})]}),(0,r.jsxs)("div",{className:"mb-3 space-y-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs font-medium text-gray-700 mb-1",children:"Definition:"}),(0,r.jsx)("p",{className:"text-sm text-gray-900",children:"simple"===u?i.definitionSimple:i.definitionClinical})]}),i.whyItMattersHere?(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs font-medium text-gray-700 mb-1",children:"Why it matters here:"}),(0,r.jsx)("p",{className:"text-sm text-gray-700",children:i.whyItMattersHere})]}):i.whyItMatters?(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs font-medium text-gray-700 mb-1",children:"Why it matters:"}),(0,r.jsx)("p",{className:"text-sm text-gray-700",children:i.whyItMatters})]}):null,i.exampleFromContext?(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs font-medium text-gray-700 mb-1",children:"Example (from this case):"}),(0,r.jsx)("p",{className:"text-xs text-gray-600 italic",children:i.exampleFromContext})]}):i.example?(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs font-medium text-gray-700 mb-1",children:"Example:"}),(0,r.jsx)("p",{className:"text-xs text-gray-600 italic",children:i.example})]}):null,i.synonymsOrRelated&&i.synonymsOrRelated.length>0&&(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs font-medium text-gray-700 mb-1",children:"Related terms:"}),(0,r.jsx)("p",{className:"text-xs text-gray-600",children:i.synonymsOrRelated.join(", ")})]}),(0,r.jsx)("div",{className:"pt-2 border-t border-gray-200",children:(0,r.jsxs)("p",{className:"text-xs text-gray-500",children:["Source: ","local"===i.source?"Vocabulary":"AI-generated"]})})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>{if(y&&!g){p(!0);try{m(i)?(h(!0),c&&c(i),setTimeout(()=>{p(!1)},300)):(p(!1),console.error("Failed to save vocab"))}catch(e){console.error("Error saving vocab:",e),p(!1)}}},disabled:v,className:"flex-1 px-3 py-2 rounded transition text-sm font-medium flex items-center justify-center gap-1 ".concat(g?"bg-green-600 text-white cursor-default":v?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-primary-600 text-white hover:bg-primary-700"),children:f?(0,r.jsx)(r.Fragment,{children:"Saving..."}):g?(0,r.jsx)(r.Fragment,{children:"✓ Saved"}):(0,r.jsx)(r.Fragment,{children:"⭐ Save to Vocab"})}),(0,r.jsx)("button",{onClick:s,className:"px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition text-sm",children:"Close"})]})]})}function u(e){let{children:t,viewMode:n}=e,i=n||"simple",[a,o]=(0,l.useState)(null),[u,d]=(0,l.useState)(null),[m,x]=(0,l.useState)(null),[g,h]=(0,l.useState)(null),[f,p]=(0,l.useState)(!1),y=(0,l.useRef)(null),v=e=>{if(!e)return!1;if(e.nodeType===Node.ELEMENT_NODE){var t;let n=null===(t=e.tagName)||void 0===t?void 0:t.toLowerCase();if("input"===n||"textarea"===n||e.isContentEditable||e.closest('input, textarea, [contenteditable="true"]'))return!0}return!1},b=(0,l.useCallback)(()=>{y.current&&clearTimeout(y.current),y.current=setTimeout(()=>{let e=window.getSelection();if(!e||0===e.rangeCount){d(null),x(null),h(null);return}let t=e.toString().trim(),n=e.getRangeAt(0);if(v(n.commonAncestorContainer)){d(null),x(null),h(null);return}if(0===t.length||t.length>60||!t.replace(/\s/g,"").length){d(null),x(null),h(null),o(null);return}let r=function(e){if(!e||0===e.rangeCount)return null;let t=e.getRangeAt(0).commonAncestorContainer;for(;t&&t.nodeType!==Node.DOCUMENT_NODE;){if(t.nodeType===Node.ELEMENT_NODE){let n=t,r=n.getAttribute("data-vocab-source"),l=n.getAttribute("data-vocab-text"),i=n.getAttribute("data-vocab-scenario-id");if(r&&l){let t=e.toString().trim(),n=l.indexOf(t);if(-1===n){let e=l.length>400?l.substring(Math.max(0,n-200),Math.min(l.length,n+t.length+200)):l;return{selectedText:t,contextText:e||l.substring(0,400),sourceType:r,scenarioMeta:i?{scenarioTitle:i}:void 0}}let a=Math.max(0,n-250),s=Math.min(l.length,n+t.length+250);return{selectedText:t,contextText:l.substring(a,s),sourceType:r,scenarioMeta:i?{scenarioTitle:i}:void 0}}}t=t.parentNode}let n=e.anchorNode;if(n&&n.textContent){let t=e.toString().trim(),r=n.textContent,l=r.indexOf(t);if(-1!==l){let e=Math.min(r.length,l+t.length+250);return{selectedText:t,contextText:r.substring(Math.max(0,l-250),e),sourceType:"chat"}}}return null}(e),l=n.getBoundingClientRect(),a={x:l.left+l.width/2,y:l.top};d(t),x(a),o(r),p(!0),s(t,i,r||void 0).then(e=>{e?h(e):h(null),p(!1)}).catch(e=>{console.error("Error resolving vocab:",e),p(!1),h(null)})},300)},[i]);return(0,l.useEffect)(()=>(document.addEventListener("selectionchange",b),()=>{document.removeEventListener("selectionchange",b),y.current&&clearTimeout(y.current)}),[b]),(0,r.jsxs)(r.Fragment,{children:[t,(g||f)&&(0,r.jsx)(c,{explanation:g,position:m,onClose:()=>{var e;d(null),x(null),h(null),o(null),null===(e=window.getSelection())||void 0===e||e.removeAllRanges()},onSave:e=>{},viewMode:i}),f&&null===g&&u&&(0,r.jsx)("div",{className:"fixed z-40 bg-white rounded-lg shadow-lg border border-gray-200 p-2",style:{left:m?"".concat(m.x,"px"):"50%",top:m?"".concat(m.y-50,"px"):"50%",transform:"translate(-50%, -100%)"},children:(0,r.jsx)("p",{className:"text-sm text-gray-600",children:"Loading explanation..."})})]})}},630:function(e,t,n){"use strict";n.d(t,{w:function(){return a}});var r=n(2265);let l="savedVocab_v1";function i(e){return e.trim().toLowerCase().replace(/\s+/g," ").replace(/[.,;:!?'"()]/g,"").trim()}function a(){let[e,t]=(0,r.useState)({}),[n,a]=(0,r.useState)(!1);(0,r.useEffect)(()=>{try{let e=localStorage.getItem(l);if(e){let n=JSON.parse(e);t(n)}a(!0)}catch(e){console.error("Error loading vocab from localStorage:",e),a(!0)}},[]),(0,r.useEffect)(()=>{if(n)try{let t=JSON.stringify(e);localStorage.setItem(l,t);let n=localStorage.getItem(l);if(n){let e=JSON.parse(n);console.log("localStorage after save:",{keyCount:Object.keys(e).length,keys:Object.keys(e).slice(0,5)})}}catch(e){console.error("Error saving vocab to localStorage:",e)}},[e,n]);let s=(0,r.useCallback)(e=>{if(!e.term||!e.definitionSimple&&!e.definitionClinical)return console.warn("Cannot save: missing term or definitions",e),!1;let n=i(e.term);return t(t=>{let r=t[n],l={...t,[n]:{...e,savedAt:(null==r?void 0:r.savedAt)||Date.now(),timesReviewed:(null==r?void 0:r.timesReviewed)||0}};return console.log("Saved vocab:",{originalTerm:e.term,normalizedKey:n,storeSize:Object.keys(l).length}),l}),!0},[]),o=(0,r.useCallback)(e=>{let n=i(e);t(e=>{let t={...e};return delete t[n],t})},[]);return{save:s,remove:o,has:(0,r.useCallback)(t=>i(t) in e,[e]),list:(0,r.useCallback)(()=>Object.values(e).sort((e,t)=>t.savedAt-e.savedAt),[e]),get:(0,r.useCallback)(t=>e[i(t)],[e]),isLoaded:n,count:Object.keys(e).length}}},3254:function(){}},function(e){e.O(0,[642,972,523,971,117,744],function(){return e(e.s=450)}),_N_E=e.O()}]);